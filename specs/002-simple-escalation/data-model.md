# Data Model: Simple Mode with Auto-Escalation

**Feature**: 002-simple-escalation
**Date**: 2026-02-16

---

## Entities

### SimpleIterationRecord

Captured once per simple mode attempt. Accumulated in-memory during the simple loop.

```typescript
interface SimpleIterationRecord {
  iteration: number;              // 1-based attempt number
  codeChangeSummary: string;      // What the Artisan changed (from ArtisanOutput.reasoning)
  testStatus: 'passed' | 'failed' | 'error';
  failedTests: string[];          // Test names that failed
  errorMessages: string[];        // Unique error messages from this iteration
  duration: number;               // ms
  cost: number;                   // USD
}
```

**Source**: Built from `ArtisanOutput` + `TestRunResult` after each simple iteration.

---

### FailureSummary

Produced once when simple mode exhausts its budget. Passed to full mode as escalation context.

```typescript
interface FailureSummary {
  totalSimpleIterations: number;
  totalSimpleCost: number;            // USD
  records: SimpleIterationRecord[];
  uniqueErrorSignatures: string[];    // Deduplicated error patterns
  finalTestState: {
    totalTests: number;
    failedTests: string[];
    lastErrorMessages: string[];
  };
  naturalLanguageSummary: string;     // Plain text block for Librarian prompt injection
}
```

**Key field**: `naturalLanguageSummary` is the text block injected into the Librarian context. Generated by `buildFailureSummary()`.

---

### EscalationEvent

Snapshot of the handoff moment. Used for reporting and diagnostics.

```typescript
interface EscalationEvent {
  triggeredAt: Date;
  reason: 'iterations-exhausted';
  simpleIterationsRun: number;
  remainingBudget: {
    costUsd: number;
    timeMinutes: number;
    iterations: number;
  };
  failureSummaryRef: FailureSummary;
}
```

---

### AgentContext Extension

One new optional field added to the existing `AgentContext` interface:

```typescript
// Addition to existing AgentContext in src/agents/base/agent-context.ts
escalationContext?: string;  // Plain text failure summary from simple mode, if escalated
```

The Librarian checks `context.escalationContext` during `initialize()` and prepends it to its analysis prompt if present.

---

## State Transitions

```
START
  │
  ▼
[Simple Mode Loop]
  │  iteration 1..N
  │  Artisan → Tests
  │
  ├─ success ──────────────────────────────► EXIT (success)
  │
  ├─ budget exhausted ─────────────────────► EXIT (budget failure)
  │
  └─ iterations exhausted && !success
       │
       ▼
    [Build FailureSummary]
       │
       ├─ remaining budget == 0 ───────────► EXIT (budget failure + summary)
       │
       └─ budget available
            │
            ▼
         [Inject escalationContext into AgentContext]
            │
            ▼
         [Full Mode Loop]
            │  iteration 1..M (remaining budget)
            │  Librarian → Artisan → Critic → Tests
            │
            ├─ success ──────────────────► EXIT (success, report both phases)
            │
            └─ budget/iterations exhausted ► EXIT (failure, report both phases)
```

---

## RunOptions Extension

New CLI options added to the existing `RunOptions` interface:

```typescript
// Addition to RunOptions in src/cli/commands/run.ts
simpleIterations?: string;  // --simple N  (default: "5")
noEscalate?: boolean;       // --no-escalate
fullMode?: boolean;         // --full
```
