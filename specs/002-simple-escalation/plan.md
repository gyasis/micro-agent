# Implementation Plan: Simple Mode with Auto-Escalation

**Branch**: `002-simple-escalation` | **Date**: 2026-02-16 | **Spec**: [spec.md](spec.md)

## Summary

Add two operating modes to `ma-loop run`: **Simple Mode** (Artisan + Tests only, cheap and fast) as the new default, and **Full Mode** (existing complete pipeline). When Simple Mode exhausts its iteration budget without success, it **auto-escalates** to Full Mode — injecting a structured failure summary so Full Mode starts informed, not blind. ~150 lines of new code, all building on existing infrastructure.

---

## Technical Context

**Language/Version**: TypeScript 5.x (Node.js 20+)
**Primary Dependencies**: commander (CLI), existing ArtisanAgent, TestRunner, AgentContext — all already in place
**Storage**: In-memory only (FailureSummary never written to disk)
**Testing**: vitest — existing 216-test suite extended with new unit + integration tests
**Target Platform**: Linux/macOS CLI
**Performance Goals**: Escalation handoff < 1 second; simple iteration overhead identical to existing artisan-only path
**Constraints**: Budget (cost/time/iterations) shared across both phases; no new LLM providers or agent types introduced
**Scale/Scope**: Affects only `src/cli/commands/run.ts`, `src/agents/base/agent-context.ts`, `src/cli/ralph-loop.ts` — targeted changes

---

## Constitution Check

No constitution.md exists for this project. Applying common-sense gates:

- ✅ No new external dependencies required
- ✅ No new agent types (reuses ArtisanAgent, LibrarianAgent, CriticAgent as-is)
- ✅ Fresh context per iteration preserved (Ralph Loop gold standard)
- ✅ Budget controls respected across both phases
- ✅ Backward compatible — `--full` flag restores original behaviour exactly
- ✅ Existing 216 tests unaffected (new tests added, none modified)

---

## Project Structure

### Documentation (this feature)

```text
specs/002-simple-escalation/
├── plan.md              ← this file
├── spec.md              ← feature specification
├── research.md          ← Phase 0 decisions
├── data-model.md        ← entity definitions and state transitions
├── quickstart.md        ← user-facing guide
├── contracts/
│   └── cli-interface.md ← CLI flags, output formats, function signatures
└── tasks.md             ← generated by /speckit.tasks (next step)
```

### Source Code Changes

```text
src/
├── agents/
│   └── base/
│       └── agent-context.ts          # +escalationContext?: string field
│                                     # +withEscalationContext() function
├── cli/
│   ├── commands/
│   │   └── run.ts                    # +runSimpleIteration()
│   │                                 # +buildFailureSummary()
│   │                                 # +simple mode loop
│   │                                 # +escalation trigger
│   │                                 # +updated reporting
│   └── ralph-loop.ts                 # +--simple, --no-escalate, --full flags

tests/
├── unit/
│   └── lifecycle/
│       └── simple-escalation.test.ts # NEW: unit tests for simple loop + escalation
└── integration/
    └── escalation-flow.test.ts       # NEW: end-to-end escalation flow test
```

---

## Implementation Phases

### Wave 1: Core Data Structures (~1 hour)

1. Add `escalationContext?: string` to `AgentContext` interface in `src/agents/base/agent-context.ts`
2. Add `withEscalationContext(context, summary)` immutable update function
3. Define `SimpleIterationRecord` and `FailureSummary` types (can live in `run.ts` or new `src/lifecycle/types.ts`)
4. Add `buildFailureSummary(records)` function that generates `naturalLanguageSummary` text

**Gate**: Types compile cleanly; `withEscalationContext` unit test passes

---

### Wave 2: Simple Mode Loop (~2 hours)

1. Extract `runSimpleIteration()` from existing `runSingleIteration()` — skips Librarian (phase 1) and Critic (phase 3), keeps Artisan (phase 2) and Tests (phase 4)
2. Add simple mode sub-loop inside `runCommand()`:
   - Runs `runSimpleIteration()` for up to N iterations
   - Accumulates `SimpleIterationRecord[]`
   - Exits on success or budget exhaustion
3. Add CLI flags to `RunOptions`: `simpleIterations`, `noEscalate`, `fullMode`
4. Register flags in `ralph-loop.ts` with commander

**Gate**: `ma-loop run src/file.ts --simple 3 --no-escalate` runs correctly; simple mode exits after 3 iterations

---

### Wave 3: Escalation Bridge (~1 hour)

1. After simple mode loop exits without success, check: `!noEscalate && !budgetExhausted`
2. Call `buildFailureSummary(records)` → inject into context via `withEscalationContext()`
3. Log escalation event with summary preview
4. Continue into existing full mode loop using the enriched context
5. Librarian agent reads `context.escalationContext` in `initialize()` and prepends to analysis prompt

**Gate**: Escalation triggers at correct iteration count; Librarian receives failure summary text

---

### Wave 4: Updated Reporting (~30 min)

1. Update final report in `runCommand()` to show per-phase stats
2. Show: `Iterations: 5 simple / 2 full / 7 total`
3. Show: `Cost: $0.025 simple / $0.041 full / $0.066 total`
4. Show mode used: `Simple → Full (escalated)` or `Simple only` or `Full only`

**Gate**: All three output formats match contracts/cli-interface.md examples

---

### Wave 5: Tests (~1.5 hours)

1. `tests/unit/lifecycle/simple-escalation.test.ts`:
   - `buildFailureSummary()` produces correct text with all error messages
   - `withEscalationContext()` returns new context without mutating original
   - Escalation trigger fires at correct iteration count
   - Budget-blocked escalation exits cleanly

2. `tests/integration/escalation-flow.test.ts`:
   - Simple mode success path (no escalation)
   - Simple mode → escalation → full mode success path
   - `--no-escalate` flag prevents full mode from running
   - `--full` flag skips simple mode entirely

**Gate**: 216 existing tests still pass; new tests pass; total ≥ 230 tests

---

## Risk & Mitigations

| Risk | Likelihood | Mitigation |
|---|---|---|
| Artisan prompt quality degrades without Librarian context | Medium | Simple mode still passes target file content + last test failure — sufficient for most bugs |
| FailureSummary too verbose for Librarian prompt | Low | Cap at 500 tokens; summarize rather than dump raw diffs |
| Budget tracking inconsistent across phases | Low | Use single shared `AgentContext.budget` throughout both phases |
| `--full` flag confusion (restores old behavior) | Low | Document clearly in quickstart; `--full` is an explicit opt-in |
